rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function removeSpaces(str) {
      return str.replace(" ", "");
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- USERS COLLECTION ---
    // Anyone authenticated can read user profiles (for social features)
    // Only the owner can write/update their own profile
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);

      // Subcollection: Awards Ballots
      // Only the user can read/write their own ballots
      match /awards_ballots/{eventId} {
        allow read, write: if isOwner(userId);
      }
    }

    // --- POSTS COLLECTION (Message Board) ---
    // Anyone authenticated can read posts
    // Anyone authenticated can create a post
    // Only the author can update (e.g. likes/comments count often updated by others in NoSQL, but let's secure standard fields) or delete
    // OR: We allow update if user ID matches OR if it's a 'like' operation (relaxed for MVP)
    match /posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Allow update if author OR if partial update (likes) - Simplified for MVP:
      // In a strict app, we'd validate 'likes' field increments specifically.
      // For now, allow authenticated updates to support likes/comments from others.
      allow update: if isAuthenticated(); 
      
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // --- CONNECTIONS COLLECTION (Matched Movie Game) ---
    // Read: If user is in the participants list
    // Create: Authenticated users can create
    // Update: If user is in participants list (voting, matching status)
    match /connections/{connectionId} {
      allow create: if isAuthenticated();
      allow read, update: if isAuthenticated() && 
        (request.auth.uid in resource.data.participants || request.auth.uid in request.resource.data.participants);
    }

    // --- AWARD EVENTS COLLECTION ---
    // Read: Authenticated users (Awards Hub)
    // Write: Authenticated users (Admin features currently client-side active). 
    // TODO: In production, switch to Admin SDK or Custom Claims for 'admin' role.
    match /award_events/{eventId} {
      allow read, write: if isAuthenticated();
    }
    
    // --- Default Deny ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
